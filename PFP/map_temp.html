<!DOCTYPE html>
<!-- reference: https://bl.ocks.org/mbostock/899711 -->

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" href="about:blank" />
    <link rel="stylesheet" href="map_style-sheet.css" />
</head>

<body>
    <div style="padding: 10px;">
        <input type="button" onclick="location.href = 'map_temp.html';" id="lbl1" value="Temperature" style="font-size:larger;">
        <input type="button" onclick="location.href = 'map_precip.html';" id="lbl2" value="Precipitation" style="font-size:larger;">
        <input type="button" onclick="location.href = 'map_both.html';" id="lbl2" value="Both" style="font-size:larger;">
    </div>

    <div id="map"></div>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAY7zlwu_IT08HhMM9W2ySjfUBCHWu-KXc&callback=initMap" async defer></script>

    <script>

        // global varibles
        var map;
        var layer;

        // Initializing Google Map
        function initMap() {
            map = new google.maps.Map(d3.select("#map").node(), {
                zoom: 10,
                center: new google.maps.LatLng(33.75, -84.39)
            });
        }

        // Reading data from the json
        d3.json("map_output.json", function (error, data) {
            if (error) throw error;

            // creating the Google OverlayView
            var overlay = new google.maps.OverlayView();

            // Add the container when the overlay is added to the map.
            overlay.onAdd = function () {
                layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "locations");
            };

            // drwing markers. Each marker is a svg element
            overlay.draw = function () {
                var projection = this.getProjection(),
                    padding = 10;

                var marker = layer.selectAll("svg")
                    .data(d3.entries(data))
                    .each(transform) // update existing markers using transfomr function
                    .enter()
                    .append("svg")
                    .each(transform)
                    .attr("class", "marker")

                // Add a circle.
                marker.append("circle")
                    .attr("cx", padding)
                    .attr("cy", padding)
                    .attr("r", getRadius)

                // Add a label..City Name
                marker.append("text")
                    .attr("x", padding - 25)
                    .attr("y", padding - 35)
                    .attr("dy", ".31em")
                    .attr("font-size", "17px")
                    .text(function (d) { return d.value.precipitation.City; });

                // Add a label ..the median value of temperature
                marker.append("text")
                    .attr("x", padding - 17)
                    .attr("y", function (d) {     // use this function here to make the text responsive to the height of the respective marker.
                        var confi = d.value.temperature.Confidence;
                        var rad = (confi * 100) / 3;
                        var pad = rad - 15;
                        return pad;
                    })
                    .attr("dy", ".31em")
                    .attr("font-size", "17px")
                    .text(function (d) {
                        var median = d.value.temperature.Median;
                        var median = median.replace(/ F/g, "\260F");
                        return median;
                    });

                // Add a label..the Range
                marker.append("text")
                    .attr("x", padding - 35)
                    .attr("y", function (d) {     // use this function here to make the text responsive to the height of the respective marker.
                        var confi = d.value.temperature.Confidence;
                        var wdht = (confi * 100) / 3;
                        var pad = wdht + 20;
                        return pad;
                    })
                    .attr("dy", ".31em")
                    .attr("font-size", "17px")
                    .text(function (d) {
                        var range = d.value.temperature.Range;
                        var range = range.replace(/ F/g, "\260F");
                        return range;
                    });

                function getRadius(d) {

                    var confi = d.value.temperature.Confidence; //get the confince value which is in string format
                    // the manipulate the confidence value to get the radius of circle and return radius
                    var rad = (confi * 100) / 3;
                    return rad;
                }

                function transform(d) {
                    d = new google.maps.LatLng(d.value.precipitation.Latitude, d.value.precipitation.Longitude);
                    d = projection.fromLatLngToDivPixel(d);
                    return d3.select(this)
                        .style("left", (d.x - padding) + "px")
                        .style("top", (d.y - padding) + "px");
                    //.on("click", function() { window.open("http://google.com"); });
                }
            };

            // Bind overlay with the map
            overlay.setMap(map);
        });

        /* ------Drawing Legend-----*/
        var jsonCircles = [
            { "x_axis": 1170, "y_axis": 50, "radius": 33 },
            { "x_axis": 1240, "y_axis": 50, "radius": 25 },
            { "x_axis": 1290, "y_axis": 50, "radius": 17 },
            { "x_axis": 1320, "y_axis": 50, "radius": 9 }];

        var jsonlegendLbl = [{ "x_axis": 1150, "y_axis": 14, "lbl": "100%" },
        { "x_axis": 1315, "y_axis": 16, "lbl": "25%" },
        { "x_axis": 1155, "y_axis": 97, "lbl": "Confidence Percentage" }];

        var svgContainer = d3.select("body").append("svg")
            .attr("height", 1)
            .attr("class", "locations");

        // add circles
        var circles = svgContainer.selectAll("circle")
            .data(jsonCircles)
            .enter()
            .append("circle");

        var circleAttributes = circles
            .attr("cx", function (d) { return d.x_axis; })
            .attr("cy", function (d) { return d.y_axis; })
            .attr("r", function (d) { return d.radius; });

        //add text
        var legendlbls = svgContainer.selectAll("text")
            .data(jsonlegendLbl)
            .enter()
            .append("text");
        var textAttributes = legendlbls
            .attr("x", function (d) { return d.x_axis; })
            .attr("y", function (d) { return d.y_axis; })
            .attr("font-size", "17px")
            .text(function (d) { return d.lbl; });
    </script>

</body>